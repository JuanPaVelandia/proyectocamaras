<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'unsafe-inline' 'self'; script-src 'self' 'unsafe-inline'" />
    <title>Frigate Health Panel</title>
    <style>
      :root {
        --bg: #ffffff; --card: #ffffff; --border: #e5e7eb; --fg: #0f172a; --muted: #64748b;
        --accent: #7c3aed; --accent2: #22c55e; --warn: #f59e0b; --err: #ef4444;
      }
      body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 28px; color: var(--fg); background: var(--bg); }
      h1 { margin: 0 0 12px; font-size: 24px; letter-spacing: .2px; text-align: center; }
      .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 20px; box-shadow: 0 8px 30px rgba(2,6,23,.06), 0 2px 8px rgba(2,6,23,.04); margin-bottom: 16px; }
      .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; justify-content: center; }
      .btn { background: linear-gradient(135deg, #7c3aed, #06b6d4); color: white; border: 0; padding: 12px 16px; border-radius: 12px; cursor: pointer;
             box-shadow: 0 8px 20px rgba(124,58,237,.25); transition: transform .2s ease, box-shadow .25s ease; }
      .btn:hover { transform: translateY(-2px); box-shadow: 0 14px 28px rgba(124,58,237,.35); }
      .btn.secondary { background: #0ea5e9; box-shadow: 0 8px 20px rgba(14,165,233,.2); }
      .big-btn { width: 180px; height: 180px; border-radius: 9999px; display:flex; align-items:center; justify-content:center; font-size: 18px; font-weight: 600;
                 background: linear-gradient(135deg, #10b981, #06b6d4); box-shadow: 0 20px 50px rgba(16,185,129,.3); border: 0; }
      .big-btn.disabled { background: linear-gradient(135deg, #9ca3af, #94a3b8); box-shadow: 0 12px 30px rgba(148,163,184,.25); cursor: default; }
      .big-btn.running { background: linear-gradient(135deg, #16a34a, #22c55e); box-shadow: 0 24px 60px rgba(34,197,94,.35), 0 0 0 0 rgba(34,197,94,.20); animation: pulseGlow 1.8s infinite ease-in-out; }
      .big-btn.disabled.running { background: linear-gradient(135deg, #16a34a, #22c55e); }
      .badge { background: #f1f5f9; color: #334155; border: 1px solid var(--border); padding: 6px 12px; border-radius: 999px; font-size: 12px; }
      .ok { color: var(--accent2) }
      .warn { color: var(--warn) }
      .err { color: var(--err) }
      table { width: 100%; border-collapse: collapse; }
      th, td { text-align: left; padding: 10px; border-bottom: 1px solid var(--border); }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }

      .hero { display: flex; flex-direction: column; align-items: center; gap: 12px; }
      .logoWrap { position: relative; width: 200px; height: 200px; border-radius: 24px; background: #ffffff; border: 1px solid var(--border);
                  display:flex; align-items:center; justify-content:center; box-shadow: 0 12px 30px rgba(2,6,23,.06); }
      .logo { width: 160px; height: 160px; object-fit: contain; }

      @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
      @keyframes pulseGlow {
        0%   { box-shadow: 0 20px 50px rgba(34,197,94,.30), 0 0 0 0 rgba(34,197,94,.20); transform: scale(1); }
        50%  { box-shadow: 0 26px 66px rgba(34,197,94,.42), 0 0 28px 10px rgba(34,197,94,.18); transform: scale(1.02); }
        100% { box-shadow: 0 20px 50px rgba(34,197,94,.30), 0 0 0 0 rgba(34,197,94,.20); transform: scale(1); }
      }
    </style>
  </head>
  <body>
    <!-- Vista principal simplificada -->
    <div id="viewMain">
      <div class="card">
        <div class="hero">
          <div id="logoWrap" class="logoWrap">
            <img class="logo" src="logo.png" alt="Vidria" />
          </div>
          <h1>Vidria</h1>
          <div class="row" style="gap:12px; align-items:center;">
            <div id="overallDot" style="width:12px;height:12px;border-radius:50%;background:#ef4444;border:1px solid #cbd5e1;"></div>
            <div id="overallText" style="font-size:16px;">Vidria no está corriendo</div>
            <span id="statusNote" class="badge">Listo</span>
          </div>
          <div class="row" id="dockerInstallRow" style="gap:12px;">
            <span style="color:#64748b;">Vidria necesita Docker para funcionar. Por favor instala Docker primero.</span>
            <button class="btn secondary" id="btnInstallDocker">Instalar Docker</button>
            <div id="installSpinner" class="spinner" style="display:none;"></div>
            <span id="installLabel" style="display:none; color:#0ea5e9;">Instalando Docker...</span>
          </div>
        </div>
        <div style="margin-top:16px;display:flex;gap:12px;flex-wrap:wrap; align-items:center; justify-content:center;">
          <button class="btn big-btn" id="btnStartVidria"><span id="btnStartText">Iniciar Vidria</span></button>
        </div>
        <div style="margin-top:16px;display:flex;justify-content:center;">
          <button class="btn secondary" id="btnShowDetails">Ver detalles técnicos</button>
        </div>
      </div>
    </div>

    <!-- Vista de detalles técnicos -->
    <div id="viewDetails" style="display:none;">
      <div class="card">
        <h1>Detalles técnicos</h1>
        <div class="row" style="gap:12px;">
          <button class="btn" id="refresh">Refrescar</button>
          <button class="btn secondary" id="btnBack">Volver</button>
        </div>
      </div>

      <div class="card">
        <h2>Docker</h2>
        <div id="dockerInfo"></div>
      </div>

      <div class="card">
        <h2>Servicios</h2>
        <table>
          <thead>
            <tr><th>Servicio</th><th>Estado</th></tr>
          </thead>
          <tbody id="svcTable"></tbody>
        </table>
      </div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      let dockerPollId = null;

      function toSpanish(status) {
        // Input examples: "running|healthy", "exited|", "not found"
        if (!status) return 'desconocido';
        if (status.includes('not found')) return 'no encontrado';
        const [st, health] = status.split('|');
        const map = { running: 'corriendo', exited: 'detenido', created: 'creado', restarting: 'reiniciando' };
        const base = map[st] || st || 'desconocido';
        const hmap = { healthy: 'saludable', unhealthy: 'no saludable' };
        return health ? `${base} (${hmap[health] || health})` : base;
      }

      function overallStatus(services) {
        const names = ['frigate', 'frigate_listener', 'frigate_proxy', 'mosquitto'];
        if (!services) return false;
        return names.every((n) => (services[n]||'').includes('running'));
      }

      async function load() {
        $('statusNote').textContent = 'Comprobando...';
        const st = await window.health.getStatus();
        $('statusNote').textContent = 'Listo';

        // MAIN VIEW summary
        const okAll = overallStatus(st.services);
        $('overallDot').style.background = okAll ? '#22c55e' : '#ef4444';
        $('overallText').textContent = okAll ? 'Vidria está corriendo' : 'Vidria no está corriendo';
        const btn = $('btnStartVidria');
        const lbl = $('btnStartText');
        const dockerInstalled = !!(st.docker && st.docker.installed);
        // Priority: if Docker not installed, disable and show clear label
        if (!dockerInstalled) {
          btn.classList.add('disabled');
          btn.classList.remove('running');
          lbl.textContent = 'Instalar Docker primero';
          btn.title = 'Instala Docker para iniciar Vidria';
        } else if (okAll) {
          btn.classList.add('disabled','running');
          lbl.textContent = 'Vidria corriendo';
          btn.title = 'Vidria está en ejecución';
        } else {
          btn.classList.remove('disabled','running');
          lbl.textContent = 'Iniciar Vidria';
          btn.title = 'Iniciar servicios Vidria';
        }
        // Toggle install Docker row
        const di = $('dockerInstallRow');
        if (st.docker && st.docker.installed) {
          di.style.display = 'none';
          // Stop polling once Docker is installed
          if (dockerPollId) { clearInterval(dockerPollId); dockerPollId = null; }
        } else {
          di.style.display = 'flex';
          // Start polling every 5s to refresh status until Docker is installed
          if (!dockerPollId) {
            dockerPollId = setInterval(load, 5000);
          }
        }

        // DETAILS VIEW
        const dockerOk = st.docker && st.docker.installed;
        const composeOk = st.compose && st.compose.installed;
        $('dockerInfo').innerHTML = `
          <div>Plataforma: <span class="badge">${st.platform}</span></div>
          <div>Docker: ${dockerOk ? '<span class="ok">OK</span>' : '<span class="err">NO</span>'} <span class="mono">${st.docker?.version || ''}</span></div>
          <div>Compose: ${composeOk ? '<span class="ok">OK</span>' : '<span class="warn">NO</span>'} <span class="mono">${st.compose?.version || ''}</span></div>
          <div>Directorio en uso: <span class="mono">${st.repoDir || ''}</span></div>
        `;
        const tbody = $('svcTable');
        tbody.innerHTML = '';
        const map = st.services || {};
        Object.keys(map).forEach((name) => {
          const raw = map[name];
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${name}</td><td>${toSpanish(raw)}</td>`;
          tbody.appendChild(tr);
        });
      }

      // Navigation
      $('btnShowDetails').addEventListener('click', () => {
        $('viewMain').style.display = 'none';
        $('viewDetails').style.display = '';
      });
      $('btnBack').addEventListener('click', () => {
        $('viewDetails').style.display = 'none';
        $('viewMain').style.display = '';
      });

      // Actions
      $('refresh').addEventListener('click', load);
      $('btnStartVidria').addEventListener('click', async () => {
        // Si ya está corriendo, no hacer nada
        if ($('btnStartVidria').classList.contains('disabled')) return;
        $('statusNote').textContent = 'Iniciando Docker...';
        await window.health.startDocker();
        $('statusNote').textContent = 'Iniciando servicios...';
        await window.health.composeUp();
        $('statusNote').textContent = 'Servicios iniciados';
        setTimeout(load, 4000);
      });

      const btnInst = document.getElementById('btnInstallDocker');
      const installSpinner = document.getElementById('installSpinner');
      const installLabel = document.getElementById('installLabel');
      if (btnInst) {
        btnInst.addEventListener('click', async () => {
          $('statusNote').textContent = 'Instalando Docker...';
          btnInst.style.display = 'none';
          if (installSpinner) installSpinner.style.display = 'inline-block';
          if (installLabel) { installLabel.style.display = 'inline-block'; installLabel.textContent = 'Instalando Docker...'; }
          const res = await window.health.installDocker();
          if (res === true) {
            $('statusNote').textContent = 'Docker instalado. Abriendo Docker...';
            if (installLabel) installLabel.textContent = 'Abriendo Docker...';
            // Abrir Docker inmediatamente tras la instalación
            await window.health.startDocker();
          } else {
            $('statusNote').textContent = (typeof res === 'string' ? res : 'Instalación finalizada');
            // En caso de error, restaurar botón e icono
            btnInst.style.display = '';
            if (installSpinner) installSpinner.style.display = 'none';
            if (installLabel) installLabel.style.display = 'none';
          }
          // Actualizar UI para ocultar el botón si ya está instalado
          setTimeout(load, 3000);
        });
      }

      load();
    </script>
  </body>
  </html>
