<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'unsafe-inline' 'self'; script-src 'self' 'unsafe-inline'; connect-src 'self' https://proyectocamaras-production.up.railway.app" />
    <title>Frigate Health Panel</title>
    <style>
      :root {
        --bg: #ffffff; --card: #ffffff; --border: #e5e7eb; --fg: #0f172a; --muted: #64748b;
        --accent: #7c3aed; --accent2: #22c55e; --warn: #f59e0b; --err: #ef4444;
      }
      body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 28px; color: var(--fg); background: var(--bg); }
      h1 { margin: 0 0 12px; font-size: 24px; letter-spacing: .2px; text-align: center; }
      .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 20px; box-shadow: 0 8px 30px rgba(2,6,23,.06), 0 2px 8px rgba(2,6,23,.04); margin-bottom: 16px; }
      .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; justify-content: center; }
      .btn { background: linear-gradient(135deg, #7c3aed, #06b6d4); color: white; border: 0; padding: 12px 16px; border-radius: 12px; cursor: pointer;
             box-shadow: 0 8px 20px rgba(124,58,237,.25); transition: transform .2s ease, box-shadow .25s ease; }
      .btn:hover { transform: translateY(-2px); box-shadow: 0 14px 28px rgba(124,58,237,.35); }
      .btn.secondary { background: #0ea5e9; box-shadow: 0 8px 20px rgba(14,165,233,.2); }
      .big-btn { width: 180px; height: 180px; border-radius: 9999px; display:flex; align-items:center; justify-content:center; font-size: 18px; font-weight: 600;
                 background: linear-gradient(135deg, #10b981, #06b6d4); box-shadow: 0 20px 50px rgba(16,185,129,.3); border: 0; }
      .big-btn.disabled { background: linear-gradient(135deg, #9ca3af, #94a3b8); box-shadow: 0 12px 30px rgba(148,163,184,.25); cursor: default; }
      .big-btn.running { background: linear-gradient(135deg, #16a34a, #22c55e); box-shadow: 0 24px 60px rgba(34,197,94,.35), 0 0 0 0 rgba(34,197,94,.20); animation: pulseGlow 1.8s infinite ease-in-out; }
      .big-btn.disabled.running { background: linear-gradient(135deg, #16a34a, #22c55e); }
      .badge { background: #f1f5f9; color: #334155; border: 1px solid var(--border); padding: 6px 12px; border-radius: 999px; font-size: 12px; }
      .ok { color: var(--accent2) }
      .warn { color: var(--warn) }
      .err { color: var(--err) }
      table { width: 100%; border-collapse: collapse; }
      th, td { text-align: left; padding: 10px; border-bottom: 1px solid var(--border); }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }

      .hero { display: flex; flex-direction: column; align-items: center; gap: 12px; }
      .logoWrap { position: relative; width: 200px; height: 200px; border-radius: 24px; background: #ffffff; border: 1px solid var(--border);
                  display:flex; align-items:center; justify-content:center; box-shadow: 0 12px 30px rgba(2,6,23,.06); }
      .logo { width: 160px; height: 160px; object-fit: contain; }

      /* Login */
      .loginWrap { max-width: 420px; margin: 0 auto; }
      .field { display:flex; flex-direction:column; gap:6px; margin: 8px 0 14px; }
      .label { font-size: 13px; color: var(--muted); }
      .input { padding: 12px 12px; border-radius: 12px; border: 1px solid var(--border); font-size: 14px; outline: none; }
      .input:focus { border-color: #7c3aed; box-shadow: 0 0 0 3px rgba(124,58,237,.12); }
      .error { color: var(--err); font-size: 13px; margin-top: 6px; text-align: center; }
      .topBar { display:flex; justify-content:flex-end; align-items:center; gap: 8px; margin-bottom: 12px; color: var(--muted); }

      @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
      @keyframes pulseGlow {
        0%   { box-shadow: 0 20px 50px rgba(34,197,94,.30), 0 0 0 0 rgba(34,197,94,.20); transform: scale(1); }
        50%  { box-shadow: 0 26px 66px rgba(34,197,94,.42), 0 0 28px 10px rgba(34,197,94,.18); transform: scale(1.02); }
        100% { box-shadow: 0 20px 50px rgba(34,197,94,.30), 0 0 0 0 rgba(34,197,94,.20); transform: scale(1); }
      }
    </style>
  </head>
  <body>
    <!-- Top bar (visible cuando hay sesión) -->
    <div id="topBar" class="topBar" style="display:none;">
      <span id="userWelcome"></span>
      <button id="btnLogout" class="btn secondary" style="padding:8px 12px; font-size: 13px;">Cerrar sesión</button>
    </div>

    <!-- Vista de Login -->
    <div id="viewLogin" style="display:none;">
      <div class="card loginWrap">
        <div class="hero">
          <div class="logoWrap">
            <img class="logo" src="logo.png" alt="Vidria" />
          </div>
          <h1>Iniciar sesión</h1>
        </div>
        <form id="loginForm" autocomplete="on">
          <div class="field">
            <label class="label" for="username">Usuario</label>
            <input id="username" name="username" class="input" type="text" placeholder="tu_usuario" required />
          </div>
          <div class="field">
            <label class="label" for="password">Contraseña</label>
            <input id="password" name="password" class="input" type="password" placeholder="••••••••" required />
          </div>
          <div class="row" style="margin-top: 8px;">
            <button id="btnLogin" type="submit" class="btn" style="width:100%; justify-content:center;">Entrar</button>
          </div>
          <div id="loginError" class="error" role="alert" style="display:none;"></div>
        </form>
      </div>
    </div>
    <!-- Vista principal simplificada -->
    <div id="viewMain">
      <div class="card">
        <div class="hero">
          <div id="logoWrap" class="logoWrap">
            <img class="logo" src="logo.png" alt="Vidria" />
          </div>
          <h1>Vidria</h1>
          <div class="row" style="gap:12px; align-items:center;">
            <div id="overallDot" style="width:12px;height:12px;border-radius:50%;background:#ef4444;border:1px solid #cbd5e1;"></div>
            <div id="overallText" style="font-size:16px;">Vidria no está corriendo</div>
            <span id="statusNote" class="badge">Listo</span>
          </div>
          <div class="row" id="dockerInstallRow" style="gap:12px;">
            <span style="color:#64748b;">Vidria necesita Docker para funcionar. Por favor instala Docker primero.</span>
            <button class="btn secondary" id="btnInstallDocker">Instalar Docker</button>
            <div id="installSpinner" class="spinner" style="display:none;"></div>
            <span id="installLabel" style="display:none; color:#0ea5e9;">Instalando Docker...</span>
          </div>
        </div>
        <div style="margin-top:16px;display:flex;gap:12px;flex-wrap:wrap; align-items:center; justify-content:center;">
          <button class="btn big-btn" id="btnStartVidria"><span id="btnStartText">Iniciar Vidria</span></button>
        </div>
        <div style="margin-top:16px;display:flex;justify-content:center;">
          <button class="btn secondary" id="btnShowDetails">Ver detalles técnicos</button>
        </div>
      </div>
    </div>

    <!-- Vista de detalles técnicos -->
    <div id="viewDetails" style="display:none;">
      <div class="card">
        <h1>Detalles técnicos</h1>
        <div class="row" style="gap:12px;">
          <button class="btn" id="refresh">Refrescar</button>
          <button class="btn secondary" id="btnBack">Volver</button>
        </div>
      </div>

      <div class="card">
        <h2>Docker</h2>
        <div id="dockerInfo"></div>
      </div>

      <div class="card">
        <h2>Servicios</h2>
        <table>
          <thead>
            <tr><th>Servicio</th><th>Estado</th></tr>
          </thead>
          <tbody id="svcTable"></tbody>
        </table>
      </div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      let dockerPollId = null;
      const LOGIN_URL = 'https://proyectocamaras-production.up.railway.app/api/auth/login';
      const AUTH_TOKEN_KEY = 'VIDRIA_AUTH_TOKEN';
      const AUTH_USER_KEY = 'VIDRIA_AUTH_USER';

      function toSpanish(status) {
        // Input examples: "running|healthy", "exited|", "not found"
        if (!status) return 'desconocido';
        if (status.includes('not found')) return 'no encontrado';
        const [st, health] = status.split('|');
        const map = { running: 'corriendo', exited: 'detenido', created: 'creado', restarting: 'reiniciando' };
        const base = map[st] || st || 'desconocido';
        const hmap = { healthy: 'saludable', unhealthy: 'no saludable' };
        return health ? `${base} (${hmap[health] || health})` : base;
      }

      function overallStatus(services) {
        const names = ['frigate', 'frigate_listener', 'frigate_proxy', 'mosquitto'];
        if (!services) return false;
        return names.every((n) => (services[n]||'').includes('running'));
      }

      // Autenticación
      function getStoredUser() {
        try { const u = localStorage.getItem(AUTH_USER_KEY); return u ? JSON.parse(u) : null; } catch { return null; }
      }
      function getStoredToken() {
        try { return localStorage.getItem(AUTH_TOKEN_KEY) || null; } catch { return null; }
      }
      function isLoggedIn() { return !!getStoredToken(); }
      function setSession(token, user) {
        localStorage.setItem(AUTH_TOKEN_KEY, token);
        if (user) localStorage.setItem(AUTH_USER_KEY, JSON.stringify(user));
      }
      function clearSession() {
        localStorage.removeItem(AUTH_TOKEN_KEY);
        localStorage.removeItem(AUTH_USER_KEY);
      }
      function showLoginView() {
        $('viewLogin').style.display = '';
        $('viewMain').style.display = 'none';
        $('viewDetails').style.display = 'none';
        $('topBar').style.display = 'none';
        setTimeout(() => { const u = $('username'); if (u) u.focus(); }, 50);
      }
      function showAppViews() {
        $('viewLogin').style.display = 'none';
        $('viewMain').style.display = '';
        $('topBar').style.display = 'flex';
        const user = getStoredUser();
        $('userWelcome').textContent = user?.username ? `Hola, ${user.username}` : 'Sesión iniciada';
      }
      function initAuthUI() {
        if (isLoggedIn()) {
          showAppViews();
          load();
        } else {
          showLoginView();
        }
      }

      async function load() {
        $('statusNote').textContent = 'Comprobando...';
        const st = await window.health.getStatus();
        $('statusNote').textContent = 'Listo';

        // MAIN VIEW summary
        const okAll = overallStatus(st.services);
        $('overallDot').style.background = okAll ? '#22c55e' : '#ef4444';
        $('overallText').textContent = okAll ? 'Vidria está corriendo' : 'Vidria no está corriendo';
        const btn = $('btnStartVidria');
        const lbl = $('btnStartText');
        const dockerInstalled = !!(st.docker && st.docker.installed);
        // Priority: if Docker not installed, disable and show clear label
        if (!dockerInstalled) {
          btn.classList.add('disabled');
          btn.classList.remove('running');
          lbl.textContent = 'Instalar Docker primero';
          btn.title = 'Instala Docker para iniciar Vidria';
        } else if (okAll) {
          btn.classList.add('disabled','running');
          lbl.textContent = 'Vidria corriendo';
          btn.title = 'Vidria está en ejecución';
        } else {
          btn.classList.remove('disabled','running');
          lbl.textContent = 'Iniciar Vidria';
          btn.title = 'Iniciar servicios Vidria';
        }
        // Toggle install Docker row
        const di = $('dockerInstallRow');
        if (st.docker && st.docker.installed) {
          di.style.display = 'none';
          // Stop polling once Docker is installed
          if (dockerPollId) { clearInterval(dockerPollId); dockerPollId = null; }
        } else {
          di.style.display = 'flex';
          // Start polling every 5s to refresh status until Docker is installed
          if (!dockerPollId) {
            dockerPollId = setInterval(load, 5000);
          }
        }

        // DETAILS VIEW
        const dockerOk = st.docker && st.docker.installed;
        const composeOk = st.compose && st.compose.installed;
        $('dockerInfo').innerHTML = `
          <div>Plataforma: <span class="badge">${st.platform}</span></div>
          <div>Docker: ${dockerOk ? '<span class="ok">OK</span>' : '<span class="err">NO</span>'} <span class="mono">${st.docker?.version || ''}</span></div>
          <div>Compose: ${composeOk ? '<span class="ok">OK</span>' : '<span class="warn">NO</span>'} <span class="mono">${st.compose?.version || ''}</span></div>
          <div>Directorio en uso: <span class="mono">${st.repoDir || ''}</span></div>
        `;
        const tbody = $('svcTable');
        tbody.innerHTML = '';
        const map = st.services || {};
        Object.keys(map).forEach((name) => {
          const raw = map[name];
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${name}</td><td>${toSpanish(raw)}</td>`;
          tbody.appendChild(tr);
        });
      }

      // Navigation
      $('btnShowDetails').addEventListener('click', () => {
        $('viewMain').style.display = 'none';
        $('viewDetails').style.display = '';
      });
      $('btnBack').addEventListener('click', () => {
        $('viewDetails').style.display = 'none';
        $('viewMain').style.display = '';
      });

      // Actions
      $('refresh').addEventListener('click', load);
      $('btnStartVidria').addEventListener('click', async () => {
        // Si ya está corriendo, no hacer nada
        if ($('btnStartVidria').classList.contains('disabled')) return;
        const btn = $('btnStartVidria');
        const lbl = $('btnStartText');
        const originalLabel = lbl ? lbl.textContent : '';
        if (btn) btn.classList.add('disabled');
        if (lbl) lbl.textContent = 'Iniciando...';
        $('statusNote').textContent = 'Iniciando Docker...';
        if (window.health.startDockerAndWait) {
          await window.health.startDockerAndWait();
        } else {
          await window.health.startDocker();
        }
        $('statusNote').textContent = 'Iniciando servicios...';
        await window.health.composeUp();
        $('statusNote').textContent = 'Servicios iniciados';
        setTimeout(() => {
          if (btn) btn.classList.remove('disabled');
          if (lbl) lbl.textContent = originalLabel || 'Iniciar Vidria';
          load();
        }, 4000);
      });

      const btnInst = document.getElementById('btnInstallDocker');
      const installSpinner = document.getElementById('installSpinner');
      const installLabel = document.getElementById('installLabel');
      if (btnInst) {
        btnInst.addEventListener('click', async () => {
          $('statusNote').textContent = 'Instalando Docker...';
          btnInst.style.display = 'none';
          if (installSpinner) installSpinner.style.display = 'inline-block';
          if (installLabel) { installLabel.style.display = 'inline-block'; installLabel.textContent = 'Instalando Docker...'; }
          const res = await window.health.installDocker();
          if (res === true) {
            $('statusNote').textContent = 'Docker instalado. Abriendo Docker...';
            if (installLabel) installLabel.textContent = 'Abriendo Docker...';
            // Abrir Docker inmediatamente tras la instalación
            await window.health.startDocker();
          } else {
            $('statusNote').textContent = (typeof res === 'string' ? res : 'Instalación finalizada');
            // En caso de error, restaurar botón e icono
            btnInst.style.display = '';
            if (installSpinner) installSpinner.style.display = 'none';
            if (installLabel) installLabel.style.display = 'none';
          }
          // Actualizar UI para ocultar el botón si ya está instalado
          setTimeout(load, 3000);
        });
      }

      // LOGIN
      const loginForm = $('loginForm');
      if (loginForm) {
        loginForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const username = $('username').value.trim();
          const password = $('password').value;
          const btn = $('btnLogin');
          const err = $('loginError');
          err.style.display = 'none';
          err.textContent = '';
          btn.disabled = true; const orig = btn.textContent; btn.textContent = 'Ingresando...';
          try {
            const res = await fetch(LOGIN_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username, password })
            });
            if (!res.ok) {
              let msg = 'Credenciales inválidas';
              try { const data = await res.json(); msg = data?.message || data?.error || msg; } catch {}
              throw new Error(msg);
            }
            const data = await res.json();
            const token = data?.accessToken || data?.access_token || data?.token;
            const user = data?.user || null;
            const resolvedUser = user || (data && data.username ? { username: data.username, email: data?.email || '' } : null);
            if (!token || !resolvedUser) throw new Error('Respuesta inválida del servidor');
            setSession(token, resolvedUser);
            try {
              const uname = resolvedUser?.username || null;
              if (uname) await window.health.setCustomerId(uname);
            } catch (e) {
              console.warn('No se pudo actualizar CUSTOMER_ID en compose:', e);
            }
            $('password').value = '';
            showAppViews();
            load();
          } catch (ex) {
            err.textContent = ex.message || 'No se pudo iniciar sesión';
            err.style.display = '';
          } finally {
            btn.disabled = false; btn.textContent = orig;
          }
        });
      }

      // LOGOUT
      const btnLogout = $('btnLogout');
      if (btnLogout) {
        btnLogout.addEventListener('click', async () => {
          clearSession();
          try { await window.health.clearCustomerId(); } catch {}
          if (dockerPollId) { clearInterval(dockerPollId); dockerPollId = null; }
          showLoginView();
        });
      }

      initAuthUI();
    </script>
  </body>
  </html>

